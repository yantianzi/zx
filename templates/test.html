{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width"/>
    <title>信号优化</title>
    <link rel="stylesheet" href="{% static 'dist/css/index.css' %}"/>
    <link rel="stylesheet" type="text/javascript"
          href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
    <script src="https://webapi.amap.com/maps?v=2.0&key=50f1eda45b413745aea17aaf2a54f2e8&plugin=AMap.RectangleEditor"></script>
    <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
    <script type="text/javascript"
            src="https://webapi.amap.com/maps?v=2.0&key=50f1eda45b413745aea17aaf2a54f2e8"></script>
    <script type="text/javascript"
            src='//webapi.amap.com/maps?v=2.0&key=50f1eda45b413745aea17aaf2a54f2e8&plugin=AMap.ToolBar'></script>
    <!-- UI组件库 1.0 -->
    <script src="//webapi.amap.com/ui/1.1/main.js?v=1.1.1"></script>
</head>
<body>
<!-- 头部 -->
<header>
    <h1>信号灯优化界面</h1>
    <div class="show-time"></div>
    <script>
        // 格式：当前时间：2022年5月3日-13时20分24秒
        var t = null;
        t = setTimeout(time, 1000); //开始运行
        function time() {
            clearTimeout(t); //清除定时器
            dt = new Date();
            var y = dt.getFullYear();
            var mt = dt.getMonth() + 1;
            var day = dt.getDate();
            var h = dt.getHours(); //获取时
            var m = dt.getMinutes(); //获取分
            var s = dt.getSeconds(); //获取秒
            document.querySelector(".show-time").innerHTML = "当前时间：" + y + "年" + mt + "月" + day + "日-" + h + "时" + m + "分" + s + "秒";
            t = setTimeout(time, 1000); //设定定时器，循环运行
        }
    </script>
</header>
<!-- 页面主体部分 -->
<section class="mainbox">
    <!-- 左侧盒子 -->
    <div class="column">
        <div class="panel" style="height:2.3rem;">
            <h2>信号灯设置方案选择</h2>
            <div style="margin:10px;">
                <select>
                    <option value="---请设置信号灯---">---请设置信号灯---</option>
                    <option value="saab">Saab</option>
                    <option value="opel">Opel</option>
                    <option value="audi">Audi</option>
                </select>
                <button type="button" value="开始仿真">开始仿真</button>
                <form id="form_show" method="post" novalidate>
                    <div class="form-group">
                        <select name="road_id" class="form-control">
                            <option value="0"> - - 请选择路口名称 - -</option>
                            {% for effect in effectlist %}
                                <option value="{{ effect.road_id }}">{{ effect.road_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <select name="configuration_id" class="form-control">
                            <option value="---请选择相位---">------请选择相位------</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                </form>
                <div class="col-xs-2">
                    <input id="btn2" type="button" class="btn btn-primary" value="提交"/>
                </div>

            </div>
            <!-- 伪元素绘制盒子下边角 -->
            <div class="panel-footer"></div>
        </div>
        <div class="panel" style="height:2.5rem;">
            <h2>路口信号灯配时方案设置</h2>
            <!-- 图表放置盒子 -->
            <div style="margin:10px;">
                <div>
                    <h4>
                        <div class="searchBox">
                            <font style="color:rgba(219,225,255,1)">路口选择:</font>
                            <input type="text" id="search" placeholder="输入关键字选取地点" value="{{ road.road.id }}"
                                   autocomplete="on">
                        </div>
                    </h4>
                    <br/>
                </div>
                <br/>
                <div>
                    <table class="table" style="color:rgba(219,225,255,1);font-size:14px;">
                        <tr>
                            <td>绿信比设置:</td>
                            <td><input id="effect_greenrate" type="text" placeholder="绿信比设置"
                                       value="{{ road.greenrate }}"/></td>
                        </tr>
                        <tr>
                            <td>周期设置:</td>
                            <td><input id="effect_flow_volume_1" type="text" placeholder="周期设置"
                                       value="{{ road.flow_volume }}"/></td>
                        </tr>
                    </table>
                </div>
            </div>
            <!-- 伪元素绘制盒子下边角 -->
            <div class="panel-footer"></div>
        </div>
        <div class="panel bar" style="height:6.2rem;">
            <h2>相位方案设置</h2>
            <!-- 图表放置盒子 -->
            <div style="margin:10px;">
                <div>
                    <h4><font style="color:rgba(219,225,255,1);">相位选择:</font>
                        <input id="configuration_id" type="text" placeholder="相位选择"
                               value="{{ configuration.configuration_id }}"/></h4>
                </div>
                <br/>
                <div>
                    <h4><font style="color:rgba(219,225,255,1);">相位顺序示意图:</font></h4>
                    <div class="chart"></div>
                </div>
                <br/>
                <div>
                    <h4><font style="color:rgba(219,225,255,1);">通行时间设置:</font></h4>
                    <div style="margin:10px;">
                        <table class="table" style="color:rgba(219,225,255,1);font-size:14px;">
                            <tr>
                                <td>开始时间:</td>
                                <td><input id="configuration_green_st" type="text" placeholder="开始时间"
                                           value="{{ configuration.green_st }}"/></td>
                            </tr>
                            <tr>
                                <td>结束时间：</td>
                                <td><input id="configuration_green_end" type="text" placeholder="结束时间"
                                           value="{{ configuration.green_end }}"/></td>
                            </tr>
                        </table>
                    </div>

                </div>
            </div>
            <!-- 伪元素绘制盒子下边角 -->
            <div class="panel-footer"></div>
        </div>
        <div class="panel" style="height:2.35rem;">
            <h2>多路口干线效能</h2>
            <div style="margin:10px;">
                <table class="table" style="color:rgba(219,225,255,1);font-size:14px;">
                    <tr>
                        <td>干线序号：</td>
                        <td><input id="backbone_id" type="text" placeholder="干线序号" value="{{ backbone.backbone_id }}"/>
                        </td>
                    </tr>
                    <tr>
                        <td>平均延误:</td>
                        <td><input id="backbone_avg_delay" type="text" placeholder="平均延误"
                                   value="{{ backbone.avg_delay }}"/></td>
                    </tr>
                    <tr>
                        <td>总体绿灯利用率:</td>
                        <td><input id="backbone_greenrate" type="text" placeholder="总体绿灯利用率"
                                   value="{{ backbone.greenrate }}"/></td>
                    </tr>
                    <tr>
                        <td>总体干线通行能力等级:
                        </th>
                        <td><input id="backbone_service_level" type="text" placeholder="总体干线通行能力等级"
                                   value="{{ backbone.service_level }}"/></td>
                    </tr>
                </table>
            </div>
            <!-- 伪元素绘制盒子下边角 -->
            <div class="panel-footer"></div>
        </div>
    </div>
    <div class="column">
        <div class="panel map" style="margin-top:20px;height:13rem" tabindex="0">
            <h2>高德地图api调用</h2>
            <!-- 地图自适应 -->
            <div class="input-card">
                <input id="setFitView" type="button" class="btn" value="地图自适应显示"/>
            </div>
            {#             <div class="input-item">#}
            {#                <input id="addMarker" type="button" class="btn" onclick="addMarker()" value="添加点标记">#}
            {#                <input id="updateMarker" type="button" class="btn" onclick="updateIcon()" value="更新点标记图标">#}
            {#            </div>#}
            {#            <div class="input-card" style='width:28rem;'>#}
            {#                <label style='color:grey'>逆地理编码，根据经纬度获取地址信息</label>#}
            {#                <div class="input-item">#}
            {#                    <div class="input-item-prepend"><span class="input-item-text">经纬度</span></div>#}
            {#                    <input id='lnglat' type="text" value=''>#}
            {#                </div>#}
            {#                <div class="input-item">#}
            {#                    <div class="input-item-prepend"><span class="input-item-text" >地址</span></div>#}
            {#                    <input id='address' type="text" disabled>#}
            {#                </div>#}
            {#                <input id="regeo" type="button" class="btn" value="经纬度 -> 地址" >#}
            {#            </div>#}
            {#            <div class="input-card" style="width: 120px">#}
            {#               <button class="btn" onclick="rectangleEditor.open()" style="margin-bottom: 5px">开始编辑</button>#}
            {#               <button class="btn" onclick="rectangleEditor.close()">结束编辑</button>#}
            {#            </div>#}
            <!-- 高德地图放置盒子 -->
            <div id="map" class="map" style="margin-top:35px;"></div>
            <!-- 伪元素绘制盒子下边角 -->
            <div class="panel-footer"></div>
        </div>
    </div>
    <div class="column">
        <div class="panel" style="height:3.25rem;">
            <h2>实时仿真结果</h2>
            <!-- 图表放置盒子 -->
            <div style="margin:10px;">
                <table id="effect_table" class="table" style="color:rgba(219,225,255,1);font-size:14px;">
                    <tr>
                        <td>路口编号:</td>
                        <td><input id="effect_id" type="text" placeholder="路口编号" value="{{ road.road_id }}"/></td>
                    </tr>
                    <tr>
                        <td>平均延误：</td>
                        <td><input id="effect_avg_delay" type="text" placeholder="平均延误" value="{{ road.avg_delay }}"/>
                        </td>
                    </tr>
                    <tr>
                        <td>周期流量:</td>
                        <td><input id="effect_flow_volume" type="text" placeholder="周期流量"
                                   value="{{ road.flow_volume }}"/></td>
                    </tr>
                    <tr>
                        <td>平均排队长度:</td>
                        <td><input id="effect_queue_length" type="text" placeholder="平均排队长度"
                                   value="{{ road.queue_length }}"/></td>
                    </tr>
                    <tr>
                        <td>相位绿灯利用率:</td>
                        <td><input id="configuration_greenrate" type="text" placeholder="相位绿灯利用率"
                                   value="{{ configuration.greenrate }}"/></td>
                    </tr>
                    <tr>
                        <td>路口通行服务等级:</td>
                        <td><input id="effect_service_level" type="text" placeholder="路口通行服务等级"
                                   value="{{ road.service_level }}"/></td>
                    </tr>
                    <tr>
                        <td>信号合理性:</td>
                        <td><input id="effect_signal_rationality" type="text" placeholder="信号合理性"
                                   value="{{ road.signal_rationality }}"/></td>
                    </tr>
                </table>
            </div>
            <!-- 伪元素绘制盒子下边角 -->
            <div class="panel-footer"></div>
        </div>
        <div class="panel" style="height:10.45rem;">
            <h2>效能对比分析</h2>
            <!-- 图表放置盒子 -->
            <div style="margin:12.5px;">
                <div>
                    <h4><font style="color:rgba(219,225,255,1);">整体延误对比图:</font></h4>
                    <div class="chart1" style="height:170px;"></div>
                </div>
                <br/>
                <div>
                    <h4><font style="color:rgba(219,225,255,1);">干线延误对比图:</font></h4>
                    <div class="chart2" style="height:170px;"></div>
                </div>
                <br/>
                <div>
                    <h4><font style="color:rgba(219,225,255,1);">路口延误对比图:</font></h4>
                    <div class="chart3" style="height:170px;"></div>
                </div>
                <br/>
            </div>
            <!-- 伪元素绘制盒子下边角 -->
            <div class="panel-footer"></div>
        </div>
    </div>
</section>
<script src="{% static 'dist/js/flexible.js' %}"></script>
<script src="{% static 'dist/js/echarts.min.js' %}"></script>
<script src="{% static 'dist/js/indextest.js' %}"></script>
<script src="{% static 'dist/js/jquery.js' %}"></script>
<!-- 引入china.js 完成地图模块 -->
<script src="{% static 'dist/js/china.js' %}"></script>
<script type="text/javascript">
    var center = ''
    var map = new AMap.Map('map', {
        width: '100%',
        height: '100%',
        center: [112.569152, 37.793622],
        zoom: 17,
        resizeEnable: true,
        rotateEnable: true,
        pitchEnable: true,
        pitch: 80,
        rotation: -15,
        // viewMode: '3D',//开启3D视图,默认为关闭
        buildingAnimation: true,//楼块出现是否带动画
        enableHighAccuracy: true,//是否使用高精度定位，默认:true
        expandZoomRange: true,
        zooms: [3, 20],
    });
    var mapInfo = {
        latitude: 0,
        longitude: 0,
        address: ''
    };

    function searchLocationId() {
        const geocoder = new AMap.Geocoder({
            radius: 1000,
            extensions: "all"
        });
        console.log([mapInfo.longitude, mapInfo.latitude]);
        geocoder.getAddress([mapInfo.longitude, mapInfo.latitude], function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                if (result && result.regeocode) {
                    // 具体地址
                    mapInfo.address = result.regeocode.formattedAddress;
                    // 省
                    mapInfo.province = result.regeocode.addressComponent.province;
                    // 市
                    mapInfo.city = result.regeocode.addressComponent.city;
                    if (mapInfo.city == '') mapInfo.city = mapInfo.province;
                    // 区
                    mapInfo.district = result.regeocode.addressComponent.district;
                    openAddress();
                }
            } else {
                alert('获取省市区失败，请重新选择地址');
            }
        });
    }

    function openAddress() {
        // cityData 你的省市区地址库为了获取省市区id
        var province = mapInfo.province;
        var city = mapInfo.city;
        var district = mapInfo.district;
        for (var i = 0; i < cityData.length; i++) {
            if (province.indexOf(cityData[i].text) >= 0 && cityData[i].children) {
                for (var j = 0; j < cityData[i].children.length; j++) {
                    if (city.indexOf(cityData[i].children[j].text) >= 0 && cityData[i].children[j].children) {
                        for (var k = 0; k < cityData[i].children[j].children.length; k++) {
                            if (cityData[i].children[j].children[k].text == district) {
                                mapInfo.provinceId = cityData[i].value;
                                mapInfo.cityId = cityData[i].children[j].value;
                                mapInfo.districtId = cityData[i].children[j].children[k].value;
                            }
                        }
                    }
                }
            }
        }
        console.log(mapInfo);
    }

    // getQueryString  获取地址栏的参数，这方法自行解决，或者留言
    // if (getQueryString('center')) {
    //     center = getQueryString('center').split(',').map(t => +t);
    // }
    //地图开始
    AMap.plugin('AMap.Geolocation', function () {
        var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,//是否使用高精度定位，默认:true
            timeout: 10000,          //超过10秒后停止定位，默认：无穷大
            convert: true,           //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
            showButton: true,        //显示定位按钮，默认：true
            showMarker: false,        //定位成功后在定位到的位置显示点标记，默认：true
            showCircle: false,        //定位成功后用圆圈表示定位精度范围，默认：true
            panToLocation: true,     //定位成功后将定位到的位置作为地图中心点，默认：true
            offset: [15, 150],//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
            position: 'LB',    //定位按钮停靠位置，默认：'LB'，左下角
        });
        map.addControl(geolocation);
        geolocation.getCurrentPosition(function (status, result) {
            if (status == 'complete') {
                console.log(result);
                mapInfo.longitude = result.position.lng;
                mapInfo.latitude = result.position.lat;
                mapInfo.address = result.formattedAddress;
                // console.log(center); // center [ll9.2323,39.89797]传入回显定位
                if (center != '') {
                    map.setCenter(center)
                } else {
                    map.setCenter([result.position.lng, result.position.lat]);
                }
                $('#address').html(result.formattedAddress);
            } else {
                if (center != '') {
                    map.setCenter(center)
                }
                console.log('失败原因排查信息:' + result.message);
            }
        });
    });
    AMapUI.loadUI(['misc/PositionPicker'], function (PositionPicker) {

        var positionPicker = new PositionPicker({
            mode: 'dragMap',//dragMap：拖拽地图，dragMarker：拖拽点
            map: map
        });

        positionPicker.on('success', function (positionResult) {
            console.log(positionResult);
            mapInfo = {
                latitude: positionResult.position.lat,
                longitude: positionResult.position.lng,
                address: positionResult.regeocode.formattedAddress
            };
            document.getElementById('address').innerHTML = positionResult.address;
        });
        positionPicker.on('fail', function (positionResult) {
            document.getElementById('address').innerHTML = ' ';
        });
        positionPicker.start();
    });
    AMapUI.loadUI(['misc/PoiPicker'], function (PoiPicker) {

        const poiPicker = new PoiPicker({
            input: 'search'
        });

        //初始化poiPicker
        poiPicker.on('poiPicked', function (poiResult) {
            console.log(poiResult);
            const item = poiResult.item;
            mapInfo = {
                latitude: item.location.lat,
                longitude: item.location.lng,
                address: item.district + ' ' + item.name + ' ' + item.address
            };
            map.setCenter([item.location.lng, item.location.lat]);
            $('#search').val('');
        });
    });
</script>
<script type="text/javascript">
// 柱状图模块---整体延误对比图
    var myChart1 = echarts.init(document.querySelector(".chart1"));
    // 2.指定配置项和数据
    myChart1.hideLoading();
    var option1 = {
        color: ['#60cda0', '#0096ff'],
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow',
                label: {
                    show: true
                }
            }
        },
        toolbox: {
            show: true,
            feature: {
                mark: {show: true},
                dataView: {show: true, readOnly: false},
                magicType: {show: true, type: ['line', 'bar']},
                restore: {show: true},
                saveAsImage: {show: true}
            }
        },
        calculable: true,
        legend: {
            data: ['Growth', '优化前', '优化后'],
            itemGap: 5,
            textStyle: {
            color: "rgba(219,225,255,1)",
          }
        },
        grid: {
            top: '10%',
            bottom: '11%',
            left: '1%',
            right: '10%',
            containLabel: true
        },
        xAxis: [
            {
                type: 'category',
                data: ["总体延误", "排队长度", "周期内流量", "绿灯利用率", "信号合理性", "停驶车辆数","平均通过车辆数","道路拥塞指数","通行服务等级"],
                lineStyle: {
                    color: "rgba(219,225,255,1)",
                    width: 0,
                    type: "solid"
                },
                axisTick: {
                    show: false,
                },
                axisLabel: {//x轴文字的配置
                    show: true,
                    textStyle: {
                        color: "rgba(219,225,255,1)",
                    }
                },
                splitLine: {//分割线配置
                    show: false,
                    lineStyle: {
                        color: "rgba(219,225,255,1)",
                    }
                }
            }
        ],
        yAxis: [
            {
                type: 'value',
                axisTick: {
                    show: false,
                  },

                axisLabel: {
                    show: true,
                    textStyle: {
                        color: "rgba(219,225,255,1)",
                    },
                    formatter: function (a) {
                        a = +a;
                        return isFinite(a) ? echarts.format.addCommas(+a) : '';
                    }
                },
                splitLine: {//分割线配置
                      show:false,
                      lineStyle: {
                          color: "rgba(219,225,255,1)",
                   }
                }
            }
        ],
        dataZoom: [
            {
                show: true,
                start: 94,
                end: 100
            },
            {
                type: 'inside',
                start: 94,
                end: 100
            },
            {
                show: true,
                yAxisIndex: 0,
                filterMode: 'empty',
                width: 30,
                height: '80%',
                showDataShadow: false,
                left: '93%'
            }
        ],
        series: [
            {
                name: '优化前',
                type: 'bar',
                data: [],
            },
            {
                name: '优化后',
                type: 'bar',
                data: [],
            }
        ]
    };
    myChart1.setOption(option1);

    // 4.让图表随屏幕自适应
  window.addEventListener('resize', function () {
    myChart1.resize();
  })

// 柱状图模块---干线延误对比图
    var myChart2 = echarts.init(document.querySelector(".chart2"));
    // 2.指定配置项和数据
    myChart2.hideLoading();
    var option2 = {
        color: ['#60cda0', '#0096ff'],
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow',
                label: {
                    show: true
                }
            }
        },
        toolbox: {
            show: true,
            feature: {
                mark: {show: true},
                dataView: {show: true, readOnly: false},
                magicType: {show: true, type: ['line', 'bar']},
                restore: {show: true},
                saveAsImage: {show: true}
            }
        },
        calculable: true,
        legend: {
            data: ['Growth', '优化前', '优化后'],
            itemGap: 5,
            textStyle: {
            color: "rgba(219,225,255,1)",
          }
        },
        grid: {
            top: '10%',
            bottom: '11%',
            left: '1%',
            right: '10%',
            containLabel: true
        },
        xAxis: [
            {
                type: 'category',
                data: ["总体延误", "排队长度", "周期内流量", "绿灯利用率", "信号合理性", "停驶车辆数","平均通过车辆数","道路拥塞指数","通行服务等级"],
                lineStyle: {
                    color: "rgba(219,225,255,1)",
                    width: 0,
                    type: "solid"
                },
                axisTick: {
                    show: false,
                },
                axisLabel: {//x轴文字的配置
                    show: true,
                    textStyle: {
                        color: "rgba(219,225,255,1)",
                    }
                },
                splitLine: {//分割线配置
                    show: false,
                    lineStyle: {
                        color: "rgba(219,225,255,1)",
                    }
                }
            }
        ],
        yAxis: [
            {
                type: 'value',
                axisTick: {
                    show: false,
                  },

                axisLabel: {
                    show: true,
                    textStyle: {
                        color: "rgba(219,225,255,1)",
                    },
                    formatter: function (a) {
                        a = +a;
                        return isFinite(a) ? echarts.format.addCommas(+a) : '';
                    }
                },
                splitLine: {//分割线配置
                      show:false,
                      lineStyle: {
                          color: "rgba(219,225,255,1)",
                   }
                }
            }
        ],
        dataZoom: [
            {
                show: true,
                start: 94,
                end: 100
            },
            {
                type: 'inside',
                start: 94,
                end: 100
            },
            {
                show: true,
                yAxisIndex: 0,
                filterMode: 'empty',
                width: 30,
                height: '80%',
                showDataShadow: false,
                left: '93%'
            }
        ],
        series: [
            {
                name: '优化前',
                type: 'bar',
                data: [],
            },
            {
                name: '优化后',
                type: 'bar',
                data: [],
            }
        ]
    };
    myChart2.setOption(option2);

    // 4.让图表随屏幕自适应
  window.addEventListener('resize', function () {
    myChart2.resize();
  })

// 柱状图模块---路网延误对比图
    var myChart3 = echarts.init(document.querySelector(".chart3"));
    // 2.指定配置项和数据
    myChart2.hideLoading();
    var option3 = {
        color: ['#60cda0', '#0096ff'],
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow',
                label: {
                    show: true
                }
            }
        },
        toolbox: {
            show: true,
            feature: {
                mark: {show: true},
                dataView: {show: true, readOnly: false},
                magicType: {show: true, type: ['line', 'bar']},
                restore: {show: true},
                saveAsImage: {show: true}
            }
        },
        calculable: true,
        legend: {
            data: ['Growth', '优化前', '优化后'],
            itemGap: 5,
            textStyle: {
            color: "rgba(219,225,255,1)",
          }
        },
        grid: {
            top: '10%',
            bottom: '11%',
            left: '1%',
            right: '10%',
            containLabel: true
        },
        xAxis: [
            {
                type: 'category',
                data: ["总体延误", "排队长度", "周期内流量", "绿灯利用率", "信号合理性", "停驶车辆数","平均通过车辆数","道路拥塞指数","通行服务等级"],
                lineStyle: {
                    color: "rgba(219,225,255,1)",
                    width: 0,
                    type: "solid"
                },
                axisTick: {
                    show: false,
                },
                axisLabel: {//x轴文字的配置
                    show: true,
                    textStyle: {
                        color: "rgba(219,225,255,1)",
                    }
                },
                splitLine: {//分割线配置
                    show: false,
                    lineStyle: {
                        color: "rgba(219,225,255,1)",
                    }
                }
            }
        ],
        yAxis: [
            {
                type: 'value',
                axisTick: {
                    show: false,
                  },

                axisLabel: {
                    show: true,
                    textStyle: {
                        color: "rgba(219,225,255,1)",
                    },
                    formatter: function (a) {
                        a = +a;
                        return isFinite(a) ? echarts.format.addCommas(+a) : '';
                    }
                },
                splitLine: {//分割线配置
                      show:false,
                      lineStyle: {
                          color: "rgba(219,225,255,1)",
                   }
                }
            }
        ],
        dataZoom: [
            {
                show: true,
                start: 94,
                end: 100
            },
            {
                type: 'inside',
                start: 94,
                end: 100
            },
            {
                show: true,
                yAxisIndex: 0,
                filterMode: 'empty',
                width: 30,
                height: '80%',
                showDataShadow: false,
                left: '93%'
            }
        ],
        series: [
            {
                name: '优化前',
                type: 'bar',
                data: [],
            },
            {
                name: '优化后',
                type: 'bar',
                data: [],
            }
        ]
    };
    myChart3.setOption(option3);

  // 4.让图表随屏幕自适应
  window.addEventListener('resize', function () {
    myChart3.resize();
  })


    $(function () {
        //页面加载完成之后自动执行
        bindBtn2Event();
    })
    {# 数据统计模块 2022.5.1 #}

    /**
     * 初始化雷达图
     * */
    function bindBtn2Event() {
        $("#btn2").click(function () {
            // 地图模块---高德地图调用
            var map = new AMap.Map('map', {
                width: '100%',
                height: '100%',
                center: [112.569152, 37.793622],
                zoom: 17,
                resizeEnable: true,
                rotateEnable: true,
                pitchEnable: true,
                pitch: 80,
                rotation: -15,
                // viewMode: '3D',//开启3D视图,默认为关闭
                buildingAnimation: true,//楼块出现是否带动画
                enableHighAccuracy: true,//是否使用高精度定位，默认:true
                expandZoomRange: true,
                zooms: [3, 20],
            });
            var mapInfo = {
                latitude: 0,
                longitude: 0,
                address: ''
            };
            var markers = [
                {   // //a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569152, 37.793622]    // 体育路与体育南路交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569191, 37.830807]    // 二营盘街与体育路交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.568853, 37.83881]    // 南内环街与体育路交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569487, 37.817377]    // 长风街与体育路交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569184, 37.807402]    // 体育路与学府街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569153, 37.796249]    // 体育路与科技街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569444, 37.815698]    // 体育路与坞城北街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569433, 37.81306]    // 体育路与八一街口交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569191, 37.830807]    // 体育路与二营盘街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.569357, 37.797413]    // 体育路与锦苑街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.564812, 37.823454]    // 体育路与亲贤街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.56171, 37.817237]    // 长风街与长治街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.552321, 37.817254]    // 长风街与平阳街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.587766, 37.817664]    // 长风街与建设南路交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.583721, 37.817604]    // 长风街与坞城路交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.587428, 37.817753]    // 太榆路长风街口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.575012, 37.816778]    // 军民路与长风街与交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.594142, 37.818546]    // 长风街与双塔南路口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.558659, 37.817783]    // 和平南路长风街口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584169, 37.807529]    // 坞城路学府街口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584043, 37.81228]    // 坞城东街与坞城路交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584173, 37.805471]    // 坞城路与师范街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584684, 37.788468]    // 坞城路与晋阳街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584862, 37.80706]    // 坞城路省府街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584899, 37.793737]    // 坞城路与南中环街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.589281, 37.812525]    // 坞城东街与太榆路交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.58354, 37.729792]    // 坞城南路与通达街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584909, 37.751326]    // 坞城南路与电子街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584225, 37.742139]    // 坞城南路与康宁街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.583565, 37.724411]    // 坞城南路与正阳街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.577701, 37.788574]    // 坞城西路与晋阳街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.580559, 37.807414]    // 坞城中路与学府街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.585281, 37.812301]    // 坞城东街与胜负街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.58371, 37.734968]    // 坞城南路与昌盛街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584894, 37.800866]    // 坞城路许坦西街与交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.583461, 37.7182]    // 坞城南路与化章街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.585091, 37.753694]    // 坞城南路与彩虹街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.577804, 37.811656]    // 坞城西路与龙城北街街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.577706, 37.786477]    // 坞城西路与针织街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584603, 37.786777]    // 坞城南路与针织街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.58354, 37.729792]    // 坞城南路与武洛街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.572074, 37.815764]    // 坞城北街与万恒街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.585227, 37.75556]    // 坞城南路与寿康街交叉口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.572074, 37.815764]    // 坞城北街西口
                }, {
                    icon: '//webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    position: [112.584232, 37.783728]    // 坞城南路与荣军北街交叉口
                }
                // {icon: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-3.png',position: []坞城南路与荣军南街交叉口},
            ];
            // 添加一些分布不均的点到地图上,地图上添加45个点标记，作为参照
            markers.forEach(function (marker) {
                new AMap.Marker({
                    map: map,
                    icon: marker.icon,
                    position: [marker.position[0], marker.position[1]],
                    offset: new AMap.Pixel(-13, -30)
                });
            });
            var center = map.getCenter();
            var setFitViewBtn = document.getElementById('setFitView');
            // 添加事件监听, 使地图自适应显示到合适的范围
            setFitViewBtn.onclick = function () {
                // 第一个参数为空，表明用图上所有覆盖物 setFitview
                // 第二个参数为false, 非立即执行
                // 第三个参数设置上左下右的空白
                map.setFitView(null, false, [150, 60, 100, 60]);
                var newCenter = map.getCenter();
                document.getElementById('centerCoord').innerHTML = '当前中心点坐标：' + newCenter.toString();
                document.getElementById('tips').innerHTML = '通过setFitView，地图自适应显示到合适的范围内,点标记已全部显示在视野中！';
            };
            // 实例化点标记
            function addMarker() {
                marker = new AMap.Marker({
                    icon: "//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",
                    position: [112.406315, 37.908775],
                    offset: new AMap.Pixel(-13, -30)
                });
                marker.setMap(map);
            }
            function updateIcon() {
                // """更新点标记"""
                marker.setIcon('//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png')
            }
            // 矩形覆盖物
            var southWest = new AMap.LngLat(112.550688, 37.839789)
            var northEast = new AMap.LngLat(112.600263, 37.719191)
            var bounds = new AMap.Bounds(southWest, northEast)
            var rectangle = new AMap.Rectangle({
                bounds: bounds,
                strokeColor: 'red',
                strokeWeight: 6,
                strokeOpacity: 0.5,
                strokeDasharray: [30, 10],
                // strokeStyle还支持 solid
                strokeStyle: 'dashed',
                fillColor: 'blue',
                fillOpacity: 0.5,
                cursor: 'pointer',
                zIndex: 50,
            })
            function searchLocationId() {
        const geocoder = new AMap.Geocoder({
            radius: 1000,
            extensions: "all"
        });
        console.log([mapInfo.longitude, mapInfo.latitude]);
        geocoder.getAddress([mapInfo.longitude, mapInfo.latitude], function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                if (result && result.regeocode) {
                    // 具体地址
                    mapInfo.address = result.regeocode.formattedAddress;
                    // 省
                    mapInfo.province = result.regeocode.addressComponent.province;
                    // 市
                    mapInfo.city = result.regeocode.addressComponent.city;
                    if (mapInfo.city == '') mapInfo.city = mapInfo.province;
                    // 区
                    mapInfo.district = result.regeocode.addressComponent.district;
                    openAddress();
                }
            } else {
                alert('获取省市区失败，请重新选择地址');
            }
        });
    }
            function openAddress() {
        // cityData 你的省市区地址库为了获取省市区id
        var province = mapInfo.province;
        var city = mapInfo.city;
        var district = mapInfo.district;
        for (var i = 0; i < cityData.length; i++) {
            if (province.indexOf(cityData[i].text) >= 0 && cityData[i].children) {
                for (var j = 0; j < cityData[i].children.length; j++) {
                    if (city.indexOf(cityData[i].children[j].text) >= 0 && cityData[i].children[j].children) {
                        for (var k = 0; k < cityData[i].children[j].children.length; k++) {
                            if (cityData[i].children[j].children[k].text == district) {
                                mapInfo.provinceId = cityData[i].value;
                                mapInfo.cityId = cityData[i].children[j].value;
                                mapInfo.districtId = cityData[i].children[j].children[k].value;
                            }
                        }
                    }
                }
            }
        }
        console.log(mapInfo);
    }
            // getQueryString  获取地址栏的参数，这方法自行解决，或者留言
            // if (getQueryString('center')) {
            //     center = getQueryString('center').split(',').map(t => +t);
            // }
            //地图开始
            AMap.plugin('AMap.Geolocation', function () {
                var geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,//是否使用高精度定位，默认:true
                    timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                    convert: true,           //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
                    showButton: true,        //显示定位按钮，默认：true
                    showMarker: false,        //定位成功后在定位到的位置显示点标记，默认：true
                    showCircle: false,        //定位成功后用圆圈表示定位精度范围，默认：true
                    panToLocation: true,     //定位成功后将定位到的位置作为地图中心点，默认：true
                    offset: [15, 150],//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                    position: 'LB',    //定位按钮停靠位置，默认：'LB'，左下角
                });
                map.addControl(geolocation);
                geolocation.getCurrentPosition(function (status, result) {
                    if (status == 'complete') {
                        console.log(result);
                        mapInfo.longitude = result.position.lng;
                        mapInfo.latitude = result.position.lat;
                        mapInfo.address = result.formattedAddress;
                        // console.log(center); // center [ll9.2323,39.89797]传入回显定位
                        if (center != '') {
                            map.setCenter(center)
                        } else {
                            map.setCenter([result.position.lng, result.position.lat]);
                        }
                        $('#address').html(result.formattedAddress);
                    } else {
                        if (center != '') {
                            map.setCenter(center)
                        }
                        console.log('失败原因排查信息:' + result.message);
                    }
                });
            });
            AMapUI.loadUI(['misc/PositionPicker'], function (PositionPicker) {
                var positionPicker = new PositionPicker({
                    mode: 'dragMap',//dragMap：拖拽地图，dragMarker：拖拽点
                    map: map
                });

                positionPicker.on('success', function (positionResult) {
                    console.log(positionResult);
                    mapInfo = {
                        latitude: positionResult.position.lat,
                        longitude: positionResult.position.lng,
                        address: positionResult.regeocode.formattedAddress
                    };
                    document.getElementById('address').innerHTML = positionResult.address;
                });
                positionPicker.on('fail', function (positionResult) {
                    document.getElementById('address').innerHTML = ' ';
                });
                positionPicker.start();
            });
            AMapUI.loadUI(['misc/PoiPicker'], function (PoiPicker) {
                const poiPicker = new PoiPicker({
                    input: 'search'
                });
                //初始化poiPicker
                poiPicker.on('poiPicked', function (poiResult) {
                    console.log(poiResult);
                    const item = poiResult.item;
                    mapInfo = {
                        latitude: item.location.lat,
                        longitude: item.location.lng,
                        address: item.district + ' ' + item.name + ' ' + item.address
                    };
                    map.setCenter([item.location.lng, item.location.lat]);
                    $('#search').val('');
                });
            });



            $.ajax({
                url: '/home/ajax/',
                type: 'post',
                data: $("#form_show").serialize(),
                success: function (res) {
                    // 将后台返回的数据更新到option中
                    if (res.status) {
                        console.log("成功！")
                        console.log(res.data.road.jingdu + ',' + res.data.road.weidu)
                        // 加载echarts数据
                        option1.series[0]['data'] = [res.data.summary.avg_delay,res.data.summary.queue_length,res.data.summary.flow_volume,res.data.summary.greenrate,res.data.summary.signal_rationality,res.data.summary.paused_vehicle_num,res.data.summary.avg_passed_vehicle_num,res.data.summary.greenrate,res.data.summary.greenrate]
                        option1.series[1]['data'] = [res.data.summaryOptimized.avg_delay,res.data.summaryOptimized.queue_length,res.data.summaryOptimized.flow_volume,res.data.summaryOptimized.greenrate,res.data.summaryOptimized.signal_rationality,res.data.summaryOptimized.paused_vehicle_num,res.data.summaryOptimized.avg_passed_vehicle_num,res.data.summaryOptimized.greenrate,res.data.summaryOptimized.greenrate]
                        myChart1.setOption(option1);
                        option2.series[0]['data'] = [res.data.backbone.avg_delay,res.data.backbone.queue_length,res.data.backbone.flow_volume,res.data.backbone.greenrate,res.data.backbone.signal_rationality,res.data.backbone.paused_vehicle_num,res.data.backbone.avg_passed_vehicle_num,res.data.backbone.greenrate,res.data.backbone.greenrate]
                        option2.series[1]['data'] = [res.data.backboneOptimized.avg_delay,res.data.backboneOptimized.queue_length,res.data.backboneOptimized.flow_volume,res.data.backboneOptimized.greenrate,res.data.backboneOptimized.signal_rationality,res.data.backboneOptimized.paused_vehicle_num,res.data.backboneOptimized.avg_passed_vehicle_num,res.data.backboneOptimized.greenrate,res.data.backboneOptimized.greenrate]
                        myChart2.setOption(option2);
                        option3.series[0]['data'] = [res.data.road.avg_delay,res.data.road.queue_length,res.data.road.flow_volume,res.data.road.greenrate,res.data.road.signal_rationality,res.data.road.paused_vehicle_num,res.data.road.avg_passed_vehicle_num,res.data.road.greenrate,res.data.road.greenrate]
                        option3.series[1]['data'] = [res.data.road.avg_delay * 0.7,res.data.road.queue_length,res.data.road.flow_volume,res.data.road.greenrate,res.data.road.signal_rationality,res.data.road.paused_vehicle_num,res.data.road.avg_passed_vehicle_num,res.data.road.greenrate + 1,res.data.road.greenrate + 1]
                        myChart3.setOption(option3);
                        // 路口信号灯配时方案设置
                        $("#road_name").val(res.data.road.road_name)
                        $("#green_letter_ratio").val("50")
                        $("#cycle_setting").val("50")
                        $("#search").val(res.data.road.road_name)
                        // 通行时间设置
                        $("#configuration_id").val(res.data.configuration.configuration_id)
                        $("#configuration_green_st").val(res.data.configuration.green_st + 's')
                        $("#configuration_green_end").val(res.data.configuration.green_end + 's')
                        $("#configuration_greenrate").val(res.data.configuration.greenrate)
                        // 实时仿真结果
                        $("#effect_id").val(res.data.road.road_id)
                        $("#effect_avg_delay").val(res.data.road.avg_delay)
                        $("#effect_flow_volume").val(res.data.road.flow_volume)
                        $("#effect_flow_volume_1").val(res.data.road.flow_volume)
                        $("#effect_queue_length").val(res.data.road.queue_length)
                        $("#effect_greenrate").val(res.data.road.greenrate)
                        $("#effect_service_level").val(res.data.road.service_level)
                        $("#effect_signal_rationality").val(res.data.road.signal_rationality)
                        //多路口干线效能
                        $("#backbone_id").val(res.data.backbone.backbone_id)
                        $("#backbone_avg_delay").val(res.data.backbone.avg_delay)
                        $("#backbone_greenrate").val(res.data.backbone.greenrate)
                        $("#backbone_service_level").val(res.data.backbone.service_level)
                    }
                }
            })

             map.add(rectangle);
            // 缩放地图到合适的视野级别
            map.setFitView([rectangle])
            var rectangleEditor = new AMap.RectangleEditor(map, rectangle)
            rectangleEditor.on('adjust', function (event) {
                log.info('触发事件：adjust')
            })
            rectangleEditor.on('end', function (event) {
                log.info('触发事件： end')
                // event.target 即为编辑后的矩形对象
            })
        })
    }
</script>
</body>
</html>